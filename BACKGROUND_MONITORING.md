# 后台监测功能说明

## 📋 功能概述

本应用实现了**后台监测**功能，可以在应用不在前台时继续监测用户的活动状态。

## 🎯 工作原理

### 监测逻辑

```
┌─────────────────────────────────────────────┐
│ 1. 用户设置监测时段（如 23:00 - 08:00）     │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 2. 注册后台任务（每15分钟执行一次）         │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 3. 后台任务定期检查：                       │
│    - 当前是否在监测时段内？                 │
│    - 最后一次打开应用是什么时候？           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 4. 监测时段结束后检查：                     │
│    - 时段内是否有打开过应用？               │
│    - 如果没有 → 发送通知                    │
│    - 如果有 → 不发送通知                    │
└─────────────────────────────────────────────┘
```

## 🔧 技术实现

### 使用的技术

1. **expo-background-fetch**
   - 注册后台任务
   - iOS 最小间隔：15 分钟
   - Android 可以更频繁

2. **expo-task-manager**
   - 管理后台任务生命周期
   - 支持应用终止后继续运行

3. **expo-notifications**
   - 发送本地通知
   - 不需要网络连接

### 关键代码

**注册后台任务：**
```typescript
await BackgroundFetch.registerTaskAsync('BACKGROUND_MONITORING_TASK', {
  minimumInterval: 15 * 60, // 15 分钟
  stopOnTerminate: false,    // 应用终止后继续运行
  startOnBoot: true,         // 开机自启动
});
```

**检查监测状态：**
```typescript
TaskManager.defineTask('BACKGROUND_MONITORING_TASK', async () => {
  // 1. 读取监测设置
  // 2. 检查是否在监测时段内
  // 3. 检查最后活动时间
  // 4. 决定是否发送通知
});
```

## ⚙️ 配置说明

### iOS 配置 (app.json)

```json
"ios": {
  "infoPlist": {
    "UIBackgroundModes": ["fetch", "remote-notification"]
  }
}
```

### Android 权限

```json
"android": {
  "permissions": [
    "android.permission.RECEIVE_BOOT_COMPLETED",
    "android.permission.SCHEDULE_EXACT_ALARM"
  ]
}
```

## ✅ 实际效果

### 场景 1：正常情况
```
监测时段：23:00 - 08:00
23:30 - 用户刷抖音（记录活动：打开应用）
02:00 - 后台任务检查（发现有活动）
08:00 - 监测时段结束
08:15 - 后台任务检查（有活动记录，不发送通知）
结果：✅ 用户无感知
```

### 场景 2：异常情况
```
监测时段：23:00 - 08:00
23:00 - 监测开始
整晚 - 用户未打开应用
08:00 - 监测时段结束
08:15 - 后台任务检查（无活动记录）
      → 📱 发送通知："请确认你的安全状态"
结果：⚠️ 用户收到提醒
```

## 📊 技术限制

### iOS 限制

1. **后台任务间隔**
   - 最小 15 分钟
   - 实际执行时间由系统决定
   - 可能延迟或跳过

2. **活动检测范围**
   - ✅ 可以检测：用户是否打开过本应用
   - ❌ 无法检测：用户是否使用其他应用
   - ❌ 无法检测：用户是否解锁屏幕
   - **原因：iOS 隐私保护，应用无法访问系统级活动数据**

3. **电池优化**
   - 系统可能限制后台任务频率
   - 低电量模式下可能不执行

### Android 限制

1. **更灵活但不稳定**
   - 可以设置更短的间隔
   - 但各厂商有自己的电池优化策略
   - 可能被系统杀死

2. **需要用户手动设置**
   - 部分手机需要关闭电池优化
   - 需要加入白名单

## 🎯 适用场景

### ✅ 推荐使用场景

1. **夜间睡眠监测**
   - 用户睡前打开应用
   - 应用在后台监测
   - 早上检查是否有异常

2. **定期签到提醒**
   - 用户每天需要打开应用一次
   - 如果忘记，收到提醒

3. **长时间不活跃提醒**
   - 检测用户是否长时间未使用应用

### ❌ 不适用场景

1. **实时监测**
   - 无法做到分钟级的精确监测
   - 后台任务有延迟

2. **全手机活动监测**
   - 无法检测用户使用其他应用
   - 只能检测是否打开过本应用

3. **紧急情况实时响应**
   - 后台任务不保证准时执行
   - 不适合紧急救援场景

## 🚀 使用指南

### 用户操作流程

1. **设置监测时段**
   ```
   打开应用 → 设置 → 选择时间段 → 保存
   ```

2. **后台运行**
   ```
   - 应用会自动在后台运行
   - 无需保持应用打开
   - 可以正常使用其他应用
   ```

3. **接收通知**
   ```
   如果在监测时段内未打开过应用
   → 收到通知
   → 点击通知打开应用
   → 确认安全状态
   ```

### 最佳实践

1. **睡前习惯**
   - 睡觉前打开应用一次
   - 让后台任务知道你"活着"

2. **电池设置**
   - iOS：无需特殊设置
   - Android：可能需要关闭电池优化

3. **通知权限**
   - 确保已授予通知权限
   - 否则无法收到提醒

## 🔍 调试信息

### 查看后台任务状态

```typescript
import * as BackgroundFetch from 'expo-background-fetch';

const status = await BackgroundFetch.getStatusAsync();
// 0: Available
// 1: Denied
// 2: Restricted
```

### 查看任务执行历史

后台任务会在控制台输出日志：
```
🔄 后台任务执行中...
⏰ 当前时间: 8:15
📋 监测时段: 23:00 - 08:00
🔍 是否在监测时段内: false
⚠️ 监测时段内无活动记录，发送通知
✅ 通知已发送
```

## ⚠️ 重要说明

1. **不是实时监测**
   - 后台任务有延迟（15分钟+）
   - 不保证准时执行

2. **活动检测范围有限**
   - 只能检测"是否打开过应用"
   - 无法检测使用其他应用的行为

3. **系统级限制**
   - 受 iOS/Android 系统限制
   - 低电量模式下可能不工作

4. **测试建议**
   - 设置短时间段测试（如5分钟）
   - 观察后台任务是否执行
   - 检查通知是否正常发送

## 📚 参考文档

- [Expo Background Fetch](https://docs.expo.dev/versions/latest/sdk/background-fetch/)
- [Expo Task Manager](https://docs.expo.dev/versions/latest/sdk/task-manager/)
- [Expo Notifications](https://docs.expo.dev/versions/latest/sdk/notifications/)

